{% extends "base.html" %}

{% block title %}Profile{% endblock %}

{% block content %}
<section style="padding: 60px 20px; background: #f7fafc; min-height: calc(100vh - 300px);">
    <div class="container" style="max-width: 1000px;">
        
        <!-- Profile Header -->
        <div class="card" style="margin-bottom: 30px;">
            <div style="display: flex; align-items: center; gap: 30px;">
                <!-- Avatar -->
                <div class="avatar" style="width: 100px; height: 100px; font-size: 40px; border-radius: 20px; overflow: hidden;">
                    <img src="{{ url_for('static', filename='images/'+current_user.image_file) }}" 
                         alt="Profile Picture" 
                         style="width: 100%; height: 100%; object-fit: cover; object-position: center 30%;">
                </div>
                
                <!-- User Info -->
                <div style="flex: 1;">
                    <h1 style="font-size: 32px; margin-bottom: 8px; color: #1a202c;">
                        {{ current_user.firstname }} {{ current_user.lastname }}
                    </h1>
                    <p style="color: #718096;">@{{ current_user.username }}</p>
                </div>
                
                <!-- Edit Button -->
                <div>
                    <button class="btn-submit" onclick="toggleEditMode()" style="height: fit-content;">
                        Edit Profile
                    </button>
                </div>
            </div>
        </div>

        <!-- Profile Details -->
        <div class="card">
            <h2 style="font-size: 24px; margin-bottom: 24px; color: #1a202c;">Profile Information</h2>
            
            <!-- View Mode -->
            <div id="viewMode">
                <div class="form-group">
                    <div class="form-label" style="text-align: left;">First Name</div>
                    <p style="color: #4a5568; font-size: 16px;">{{ current_user.firstname }}</p>
                </div>
                
                <div class="form-group">
                    <div class="form-label" style="text-align: left;">Last Name</div>
                    <p style="color: #4a5568; font-size: 16px;">{{ current_user.lastname }}</p>
                </div>
                
                <div class="form-group">
                    <div class="form-label" style="text-align: left;">Username</div>
                    <p style="color: #4a5568; font-size: 16px;">{{ current_user.username }}</p>
                </div>
                
                <div class="form-group">
                    <div class="form-label" style="text-align: left;">Email Address</div>
                    <p style="color: #4a5568; font-size: 16px;">{{ current_user.email }}</p>
                </div>
                
                <div class="form-group">
                    <div class="form-label" style="text-align: left;">Member Since</div>
                    <p style="color: #4a5568; font-size: 16px;">
                        {{ current_user.registration_date.strftime('%B %d, %Y') }}
                    </p>
                </div>
            </div>

            <!-- Edit Mode (Hidden by default) -->
            <form id="editMode" style="display: none;" method="POST" action="{{ url_for('profile_page') }}" enctype="multipart/form-data">
                {{ update_form.hidden_tag() }}
                
                <div class="form-group">
                    {{ update_form.firstname.label(class="form-label") }}
                    {{ update_form.firstname(class="form-input") }}
                    {% for error in update_form.firstname.errors %}
                        <p class="form-hint text-danger">{{ error }}</p>
                    {% endfor %}
                </div>
                
                <div class="form-group">
                    {{ update_form.lastname.label(class="form-label") }}
                    {{ update_form.lastname(class="form-input") }}
                    {% for error in update_form.lastname.errors %}
                        <p class="form-hint text-danger">{{ error }}</p>
                    {% endfor %}
                </div>
                
                <div class="form-group">
                    {{ update_form.username.label(class="form-label") }}
                    {{ update_form.username(class="form-input") }}
                    {% for error in update_form.username.errors %}
                        <p class="form-hint text-danger">{{ error }}</p>
                    {% endfor %}
                </div>
                
                <div class="form-group">
                    {{ update_form.email.label(class="form-label") }}
                    {{ update_form.email(class="form-input") }}
                    {% for error in update_form.email.errors %}
                        <p class="form-hint text-danger">{{ error }}</p>
                    {% endfor %}
                </div>
                
                <div class="form-group">
                    {{ update_form.image.label(class="form-label") }}
                    {{ update_form.image(class="form-input", style="padding: 8px;") }}
                    {% for error in update_form.image.errors %}
                        <p class="form-hint text-danger">{{ error }}</p>
                    {% endfor %}
                    <small style="color: #718096; font-size: 0.875rem;">Upload a new profile picture (optional)</small>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    {{ update_form.submit(class="btn-submit") }}
                    <button type="button" class="btn-submit" onclick="toggleEditMode()" 
                            style="background: #e2e8f0; color: #4a5568;">
                        Cancel
                    </button>
                </div>
            </form>
        </div>

        <!-- Change Password Section -->
        <div class="card" style="margin-top: 30px;">
            <h2 style="font-size: 24px; margin-bottom: 24px; color: #1a202c;">Change Password</h2>
            
            <form method="POST" action="{{ url_for('profile_page') }}">
                {{ password_form.hidden_tag() }}
                
                <div class="form-group">
                    {{ password_form.current_password.label(class="form-label") }}
                    {{ password_form.current_password(class="form-input") }}
                    {% for error in password_form.current_password.errors %}
                        <p class="form-hint text-danger">{{ error }}</p>
                    {% endfor %}
                </div>
                
                <div class="form-group">
                    {{ password_form.new_password.label(class="form-label") }}
                    {{ password_form.new_password(class="form-input") }}
                    {% for error in password_form.new_password.errors %}
                        <p class="form-hint text-danger">{{ error }}</p>
                    {% endfor %}
                </div>
                
                <div class="form-group">
                    {{ password_form.confirm_password.label(class="form-label") }}
                    {{ password_form.confirm_password(class="form-input") }}
                    {% for error in password_form.confirm_password.errors %}
                        <p class="form-hint text-danger">{{ error }}</p>
                    {% endfor %}
                </div>
                
                {{ password_form.submit(class="btn-submit") }}
            </form>
        </div>

        <!-- My Posted Jobs Section -->
        {% if jobs and jobs.count()>0 %}
            <div class="card" style="margin-top: 30px;">
                <h2 style="font-size: 24px; margin-bottom: 24px; color: #1a202c;">My Posted Jobs</h2>
                {% for job in jobs %}
                    <div class="job-card">
                        <div class="job-card-header">
                            <h3 class="job-title">{{ job.title }}</h3>
                            <span class="job-category-badge" style="margin-left:auto;">{{ job.category }}</span>
                        </div>
                        
                        <div class="job-details">
                            <span class="job-detail-item">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                                </svg>
                                {{ job.location }}
                            </span>
                            <span class="job-detail-item">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M4 10.781c.148 1.667 1.513 2.85 3.591 3.003V15h1.043v-1.216c2.27-.179 3.678-1.438 3.678-3.3 0-1.59-.947-2.51-2.956-3.028l-.722-.187V3.467c1.122.11 1.879.714 2.07 1.616h1.47c-.166-1.6-1.54-2.748-3.54-2.875V1H7.591v1.233c-1.939.23-3.27 1.472-3.27 3.156 0 1.454.966 2.483 2.661 2.917l.61.162v4.031c-1.149-.17-1.94-.8-2.131-1.718H4zm3.391-3.836c-1.043-.263-1.6-.825-1.6-1.616 0-.944.704-1.641 1.8-1.828v3.495l-.2-.05zm1.591 1.872c1.287.323 1.852.859 1.852 1.769 0 1.097-.826 1.828-2.2 1.939V8.73l.348.086z"/>
                                </svg>
                                ${{ "{:,}".format(job.salary) }}
                            </span>
                            <div class="right-actions">
                                <span class="update-tag">
                                    <a href="{{ url_for('update_job_page', job_id=job.id) }}" class="update-btn">Update</a>
                                </span>
                                <span class="delete-tag">
                                    <form id="deleteForm{{ job.id }}" 
                                          action="{{ url_for('delete_job', job_id=job.id) }}" 
                                          method="POST">
                                        {{ update_form.hidden_tag() }}
                                        <button type="button" 
                                                class="delete-btn" 
                                                data-job-id="{{ job.id }}"
                                                data-job-title="{{ job.title|escape }}"
                                                onclick="showDeleteModal(this)">
                                            Delete
                                        </button>
                                    </form>
                                </span>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="card" style="margin-top: 30px;">
                <h2 style="font-size: 24px; margin-bottom: 24px; color: #1a202c;">My Posted Jobs</h2>
                <p style="color: #718096;">You haven't posted any jobs yet.</p>
            </div>
        {% endif %}
    </div>
</section>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);">
    <div class="modal-content" style="background-color: white; margin: 15% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);">
        <div class="modal-header" style="font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #1a202c;">
            Confirm Job Deletion
        </div>
        <div class="modal-body" style="margin-bottom: 25px; color: #4a5568; line-height: 1.6;">
            Are you sure you want to delete "<strong><span id="jobTitle"></span></strong>"?
            <br><br>
            <span style="color: #dc3545; font-weight: 500;">âš  This action cannot be undone.</span>
        </div>
        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px;">
            <button class="btn-cancel" onclick="closeDeleteModal()" style="padding: 10px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; background-color: #e2e8f0; color: #4a5568;">Cancel</button>
            <button class="btn-confirm" onclick="confirmDelete()" style="padding: 10px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; background-color: #dc3545; color: white;">Yes, Delete Job</button>
        </div>
    </div>
</div>

<script>
function toggleEditMode() {
    const viewMode = document.getElementById('viewMode');
    const editMode = document.getElementById('editMode');
    
    if (viewMode.style.display === 'none') {
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
    } else {
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
    }
}

// Delete Modal Functions
let currentJobId = null;

function showDeleteModal(button) {
    const jobId = button.getAttribute('data-job-id');
    const jobTitle = button.getAttribute('data-job-title');
    
    currentJobId = jobId;
    document.getElementById('jobTitle').textContent = jobTitle;
    document.getElementById('deleteModal').style.display = 'block';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    currentJobId = null;
}

function confirmDelete() {
    if (currentJobId) {
        document.getElementById('deleteForm' + currentJobId).submit();
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('deleteModal');
    if (event.target === modal) {
        closeDeleteModal();
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeDeleteModal();
    }
});
</script>
{% endblock %}